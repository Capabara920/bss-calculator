<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BSS Precision Calculator - Joint Competition</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background: #121212; color: #e0e0e0; padding: 10px; margin: 0; display: flex; flex-direction: column; align-items: center; min-height: 100vh; }
        .top-bar { width: 95%; max-width: 1220px; display: flex; justify-content: center; align-items: center; gap: 20px; margin-bottom: 25px; background: #1e1e1e; padding: 15px 25px; border-radius: 12px; border: 1px solid #333; box-sizing: border-box; }
        #main_wrapper { display: flex; flex-direction: row; flex-wrap: wrap; gap: 25px; justify-content: center; width: 100%; padding-bottom: 40px; }
        .container { flex: 0 1 600px; width: 100%; max-width: 600px; background: #1e1e1e; padding: 20px; border-radius: 12px; box-shadow: 0 5px 20px rgba(0,0,0,0.5); border: 1px solid #333; height: fit-content; box-sizing: border-box; }
        .row { margin-bottom: 18px; }
        .section-title { font-size: 11px; color: #2196f3; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 10px; display: flex; align-items: center; font-weight: bold; }
        .section-title::after { content: ""; flex: 1; height: 1px; background: #333; margin-left: 10px; }
        label { display: block; font-size: 11px; color: #888; margin-bottom: 4px; }
        input, select { width: 100%; padding: 10px; background: #252525; border: 1px solid #333; border-radius: 4px; color: #fff; font-size: 13px; box-sizing: border-box; }
        .grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; }
        .attr-card { background: #252525; padding: 15px; border-radius: 8px; margin-bottom: 15px; border: 1px solid #333; position: relative; }
        .attr-card.a1 { border-top: 3px solid #2196f3; }
        .attr-card.a2 { border-top: 3px solid #4caf50; }
        .attr-card.a3 { border-top: 3px solid #9c27b0; }
        .attr-label { position: absolute; top: -10px; left: 10px; background: #1e1e1e; padding: 0 8px; font-size: 10px; font-weight: bold; display: flex; align-items: center; gap: 8px; }
        .btn-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; margin-top: 15px; }
        button { padding: 12px; color: #fff; border: none; border-radius: 4px; font-size: 14px; cursor: pointer; font-weight: bold; transition: opacity 0.2s; }
        button:hover { opacity: 0.8; }
        .btn-calc { background: #2196f3; }
        .btn-reset { background: #444; }
        .btn-mode { background: #673ab7; }
        .result-box { margin-top: 20px; display: none; }
        /* 綜合機率樣式 */
        .joint-res { background: #2c3e50; border: 1px solid #f1c40f; padding: 15px; border-radius: 12px; margin-bottom: 20px; text-align: center; }
        .joint-val { color: #f1c40f; font-size: 20px; font-weight: bold; margin: 5px 0; }
        .res-section { background: #252525; padding: 15px; border-radius: 8px; border: 1px solid #444; }
        .res-item { display: flex; flex-direction: column; padding: 12px; border-radius: 6px; margin-bottom: 20px; border: 1px solid #333; position: relative; transition: 0.3s; }
        .target-highlight { border-color: #f1c40f !important; background: rgba(241, 196, 15, 0.08); }
        .tag-container { position: absolute; top: -12px; left: 10px; display: flex; gap: 5px; }
        .line-tag { font-size: 10px; padding: 2px 10px; border-radius: 4px; font-weight: bold; color: white; box-shadow: 0 2px 4px rgba(0,0,0,0.3); }
        .tag-a1 { background: #2196f3; }
        .tag-a2 { background: #4caf50; }
        .tag-a3 { background: #9c27b0; }
        .res-main { display: flex; justify-content: space-between; font-size: 14px; align-items: center; border-bottom: 1px solid #333; padding-bottom: 5px; margin-bottom: 5px; }
        .attr-info-line { font-size: 11px; color: #ccc; display: flex; justify-content: space-between; margin-top: 2px; }
        .val { color: #4caf50; font-weight: bold; }
        .cost-val { color: #f1c40f; font-weight: bold; }
        .count-select { width: 70px; padding: 8px; background: #333; border: 1px solid #444; color: white; cursor: pointer; }
    </style>
</head>
<body>

<div class="top-bar">
    <div style="display:flex; flex-direction:column; gap:5px; align-items:center;">
        <label>Windows</label>
        <select class="count-select" id="calc_count" onchange="initCalculators()">
            <option value="1">1</option>
            <option value="2">2</option>
        </select>
    </div>
</div>

<div id="main_wrapper"></div>

<script>
let displayModes = {}; 

function initCalculators() {
    const count = document.getElementById('calc_count').value;
    const wrapper = document.getElementById('main_wrapper');
    wrapper.innerHTML = '';
    displayModes = {};
    for (let i = 1; i <= count; i++) {
        displayModes[i] = 0;
        wrapper.innerHTML += createCalculatorHTML(i);
        renderAttrInputs(i);
    }
}

function createCalculatorHTML(id) {
    return `
    <div class="container" id="calc_container_${id}">
        <div class="section-title">Global Potential</div>
        <div class="row">
            <div style="width: 120px;">
                <label>Potential (0-5)</label>
                <input type="number" id="pot_${id}" step="0.5" value="5" min="0" max="5">
            </div>
        </div>

        <div class="row">
            <div class="grid">
                <div><label>S / H / C / Debug Wax</label><div style="display:flex;gap:2px;">
                    <input type="number" id="nS_${id}" placeholder="S" value="0" min="0">
                    <input type="number" id="nH_${id}" placeholder="H" value="0" min="0">
                    <input type="number" id="nC_${id}" placeholder="C" value="0" min="0">
                    <input type="number" id="nD_${id}" placeholder="D" value="0" min="0">
                </div></div>
                <div><label>Attr Count</label>
                    <select id="attr_count_${id}" onchange="renderAttrInputs(${id})">
                        <option value="1">1 Attr</option>
                        <option value="2" selected>2 Attrs</option>
                        <option value="3">3 Attrs</option>
                    </select>
                </div>
                <div><label>Unit Cost</label><input type="number" id="unit_cost_${id}" value="0" min="0"></div>
            </div>
        </div>

        <div id="attr_container_${id}"></div>

        <div class="btn-grid">
            <button class="btn-calc" onclick="calc(${id})">Analyze Targets</button>
            <button id="modeBtn_${id}" class="btn-mode" onclick="toggleMode(${id})">Mode: Full</button>
            <button class="btn-reset" onclick="resetCalc(${id})">Reset</button>
        </div>

        <div id="res_${id}" class="result-box">
            <div id="joint_container_${id}"></div>
            <div class="res-section"><div id="hit_result_${id}"></div></div>
        </div>
    </div>`;
}

function renderAttrInputs(calcId) {
    const count = document.getElementById(`attr_count_${calcId}`).value;
    const container = document.getElementById(`attr_container_${calcId}`);
    container.innerHTML = '';
    for(let i=1; i<=count; i++) {
        container.innerHTML += `
        <div class="attr-card a${i}">
            <div class="attr-label" style="color:${['','#2196f3','#4caf50','#9c27b0'][i]}">
                Attr ${i}
                <span><input type="checkbox" id="isC${i}_${calcId}" style="width:auto;"> C-Only</span>
                <span><input type="checkbox" id="useBias${i}_${calcId}" style="width:auto;" onchange="toggleBiasView(${i}, ${calcId})"> Bias</span>
            </div>
            <div class="grid" style="grid-template-columns: 1.2fr 1fr;">
                <div><label>Chance % (Min/Max)</label><div style="display:flex;gap:2px;">
                    <input type="number" id="rollMin${i}_${calcId}" value="0" step="0.1" min="0"><input type="number" id="rollMax${i}_${calcId}" value="0" step="0.1" min="0">
                </div></div>
                <div><label>Target Value</label>
                    <input type="number" id="tar_${i}_${calcId}" value="1" min="0">
                </div>
            </div>
            <div id="biasArea${i}_${calcId}" class="grid" style="margin-top:8px; display:none;">
                <div><label>Bias</label><input type="number" id="bias${i}_${calcId}" value="1"></div>
                <div><label>Bias Inc</label><input type="number" id="upB${i}_${calcId}" value="1"></div>
                <div><label>Lucky Inc</label><input type="number" id="upA${i}_${calcId}" value="2"></div>
            </div>
            <div id="noBiasArea${i}_${calcId}" class="grid" style="margin-top:8px;">
                <div style="grid-column: span 3;"><label>Success Increment</label><input type="number" id="fixedUp${i}_${calcId}" value="1"></div>
            </div>
        </div>`;
    }
}

function toggleBiasView(i, id) {
    const b = document.getElementById(`useBias${i}_${id}`).checked;
    document.getElementById(`biasArea${i}_${id}`).style.display = b ? 'grid' : 'none';
    document.getElementById(`noBiasArea${i}_${id}`).style.display = b ? 'none' : 'grid';
}

function fact(n) { if(n<=1) return 1; let r=1; for(let i=2;i<=n;i++) r*=i; return r; }

function getMultinomial(n, k_arr, p_arr) {
    let coeff = fact(n);
    let prob = 1.0;
    for(let i=0; i<k_arr.length; i++) {
        coeff /= fact(k_arr[i]);
        prob *= Math.pow(p_arr[i], k_arr[i]);
    }
    return coeff * prob;
}

function formatUnit(num) {
    if (num < 1000) return Math.round(num).toString();
    const units = ["", "k", "m", "b", "t"];
    let i = 0;
    while (num >= 1000 && i < units.length - 1) { num /= 1000; i++; }
    return num.toFixed(num < 10 ? 2 : 1).replace(/\.0$/, "") + units[i];
}

function formatProb(p, calcId) {
    let pct = p * 100;
    if (pct === 0) return "0%";
    const mode = displayModes[calcId];
    if (mode === 0) return pct.toFixed(8).replace(/\.?0+$/, "") + "%";
    let s = pct.toFixed(20);
    let m = s.match(/[1-9]/);
    return m ? s.substring(0, m.index + 3) + "%" : "0%";
}

function resetCalc(id) { initCalculators(); }

function toggleMode(id) { 
    displayModes[id] = (displayModes[id] + 1) % 3; 
    document.getElementById(`modeBtn_${id}`).innerText="Mode: "+["Full","Auto","3-Dig"][displayModes[id]]; 
    calc(id); 
}

function calc(id) {
    const pot = parseFloat(document.getElementById(`pot_${id}`).value);
    const nS = parseInt(document.getElementById(`nS_${id}`).value)||0, 
          nH = parseInt(document.getElementById(`nH_${id}`).value)||0, 
          nC = parseInt(document.getElementById(`nC_${id}`).value)||0,
          nD = parseInt(document.getElementById(`nD_${id}`).value)||0; // Debug Wax

    const unitCost = parseFloat(document.getElementById(`unit_cost_${id}`).value)||0;
    const attrCount = parseInt(document.getElementById(`attr_count_${id}`).value);

    let attrs = [];
    for(let i=1; i<=attrCount; i++) {
        let rMin = parseFloat(document.getElementById(`rollMin${i}_${id}`).value)/100, 
            rMax = parseFloat(document.getElementById(`rollMax${i}_${id}`).value)/100;
        let p = rMin + (pot/5)*(rMax - rMin);
        let tar = parseFloat(document.getElementById(`tar_${i}_${id}`).value);
        let useB = document.getElementById(`useBias${i}_${id}`).checked;
        
        // Calculate average increment
        let inc = 1;
        if(useB) {
            let bias = parseFloat(document.getElementById(`bias${i}_${id}`).value);
            let upB = parseFloat(document.getElementById(`upB${i}_${id}`).value);
            let upA = parseFloat(document.getElementById(`upA${i}_${id}`).value);
            let probLucky = (1 + pot * (bias-1)/10) / (bias + 1);
            inc = (upA * probLucky) + (upB * (1 - probLucky));
        } else {
            inc = parseFloat(document.getElementById(`fixedUp${i}_${id}`).value);
        }

        attrs.push({ id: i, p: p, hitsNeeded: Math.ceil(tar/inc), isC: document.getElementById(`isC${i}_${id}`).checked, avgInc: inc });
    }

    // Pool Logic: S=1, H=2, C=4, Debug=4
    // We treat D as part of the Caustic pool
    let causticPool = (nC + nD) * 4;
    let totalPool = nS + nH * 2 + causticPool;
    
    let jointTotalProb = 0;
    let singleAttrRowProbs = Array(totalPool + 1).fill(0).map(() => Array(attrCount).fill(0));

    // Simple probability distribution (Binomial Approximation for each k)
    // To maintain your "metAll" and "singleAttrRowProbs" structure:
    for (let k1 = 0; k1 <= totalPool; k1++) {
        if (attrs[0].isC && k1 > causticPool) continue;
        for (let k2 = 0; k2 <= (attrCount >= 2 ? totalPool - k1 : 0); k2++) {
            if (attrCount >= 2 && attrs[1].isC && k2 > causticPool) continue;
            for (let k3 = 0; k3 <= (attrCount >= 3 ? totalPool - k1 - k2 : 0); k3++) {
                if (attrCount >= 3 && attrs[2].isC && k3 > causticPool) continue;

                let kFail = totalPool - k1 - k2 - k3;
                let k_arr = [k1]; if(attrCount>=2) k_arr.push(k2); if(attrCount>=3) k_arr.push(k3); k_arr.push(kFail);
                let p_arr = [attrs[0].p]; if(attrCount>=2) p_arr.push(attrs[1].p); if(attrCount>=3) p_arr.push(attrs[2].p);
                let sumP = p_arr.reduce((a,b)=>a+b, 0);
                p_arr.push(Math.max(0, 1 - sumP));

                let pCombo = getMultinomial(totalPool, k_arr, p_arr);
                
                if (k1 > 0) for(let t=1; t<=k1; t++) if(t <= totalPool) singleAttrRowProbs[t][0] += pCombo;
                if (attrCount>=2 && k2 > 0) for(let t=1; t<=k2; t++) if(t <= totalPool) singleAttrRowProbs[t][1] += pCombo;
                if (attrCount>=3 && k3 > 0) for(let t=1; t<=k3; t++) if(t <= totalPool) singleAttrRowProbs[t][2] += pCombo;

                let metAll = (k1 >= attrs[0].hitsNeeded);
                if(attrCount>=2) metAll = metAll && (k2 >= attrs[1].hitsNeeded);
                if(attrCount>=3) metAll = metAll && (k3 >= attrs[2].hitsNeeded);
                if(metAll) jointTotalProb += pCombo;
            }
        }
    }

    // Render Joint Results (Using your original style)
    let jointHtml = `
        <div class="joint-res">
            <div style="font-size:11px; color:#f1c40f;">ALL TARGETS MET (Joint Prob)</div>
            <div class="joint-val">${formatProb(jointTotalProb, id)}</div>
            <div style="font-size:11px; color:#aaa;">
                Avg Cost: ${jointTotalProb > 0 ? formatUnit(1/jointTotalProb) : 'Inf'} units
                ${unitCost > 0 ? ` | <span class="cost-val">${formatUnit(unitCost/jointTotalProb)}</span> total` : ''}
            </div>
        </div>`;
    document.getElementById(`joint_container_${id}`).innerHTML = jointHtml;

    // Render Detailed Success List (Using your original style)
    let hitHtml = "";
    for (let t = 1; t <= totalPool; t++) {
        let matched = attrs.filter(a => a.hitsNeeded === t);
        let lines = attrs.map((a, idx) => `
            <div class="attr-info-line">
                <span style="color:${['','#2196f3','#4caf50','#9c27b0'][a.id]}">Attr ${a.id}${a.isC?'(C)':''}: ${singleAttrRowProbs[t][idx] > 0 ? formatProb(singleAttrRowProbs[t][idx], id) : 'N/A'}</span>
                <span>~${(t * a.avgInc).toFixed(2)} val</span>
            </div>
        `).join('');

        if (attrs.some(a => singleAttrRowProbs[t][a.id-1] > 0)) {
            hitHtml += `
            <div class="res-item ${matched.length>0?'target-highlight':''}">
                <div class="tag-container">${matched.map(a => `<div class="line-tag tag-a${a.id}">${a.id}${a.isC?'C':''}</div>`).join('')}</div>
                <div class="res-main">
                    <span><b>${t}</b> Successes</span>
                </div>
                ${lines}
            </div>`;
        }
    }
    document.getElementById(`hit_result_${id}`).innerHTML = hitHtml;
    document.getElementById(`res_${id}`).style.display = 'block';
}

initCalculators();
</script>
</body>
</html>